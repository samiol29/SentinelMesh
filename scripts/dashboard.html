<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>SENTINEL | CORE V6.8</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;500&display=swap" rel="stylesheet">
    <style>
        body { background-color: #050505; color: #d1d5db; font-family: 'JetBrains Mono', monospace; background-image: radial-gradient(#111 1px, transparent 1px); background-size: 30px 30px; }
        .tech-border { border: 1px solid #222; position: relative; background: rgba(10, 10, 10, 0.95); transition: all 0.2s; }
        .tech-border::before { content: ""; position: absolute; top: -1px; left: -1px; width: 10px; height: 10px; border-top: 2px solid #10b981; border-left: 2px solid #10b981; }
        .tech-border::after { content: ""; position: absolute; bottom: -1px; right: -1px; width: 10px; height: 10px; border-bottom: 2px solid #10b981; border-right: 2px solid #10b981; }
        .status-dot { width: 6px; height: 6px; border-radius: 50%; display: inline-block; }
        .route-active { color: #10b981; border-color: #10b981; background: rgba(16, 185, 129, 0.1); }
        .route-manual { color: #f59e0b; border-color: #f59e0b; background: rgba(245, 158, 11, 0.1); }
    </style>
</head>
<body class="p-8">
    <div class="flex justify-between items-end mb-8 border-b border-zinc-800 pb-6">
        <div>
            <div class="text-[10px] text-zinc-500 tracking-[0.4em] uppercase mb-1 font-bold">Sentinel Mesh Defense</div>
            <h1 class="text-2xl font-light uppercase tracking-tighter text-white">Sentinel<span class="font-bold">Mesh</span></h1>
        </div>
        <div class="text-right">
            <div id="route-label" class="text-[9px] text-zinc-600 uppercase mb-2 tracking-widest italic">Analyzing Topology...</div>
            <div class="flex space-x-2">
                <button onclick="setOverride('a')" class="px-4 py-1.5 bg-zinc-900 border border-zinc-800 text-[8px] uppercase hover:border-zinc-500">Force A</button>
                <button onclick="setOverride('b')" class="px-4 py-1.5 bg-zinc-900 border border-zinc-800 text-[8px] uppercase hover:border-zinc-500">Force B</button>
                <button onclick="setOverride('clear')" class="px-4 py-1.5 bg-emerald-900/20 border border-emerald-500 text-[8px] uppercase font-bold text-white hover:bg-emerald-900/40">Restore Autonomy</button>
            </div>
        </div>
    </div>

    <div class="flex justify-center items-center space-x-4 mb-12">
        <div id="path-a" class="tech-border px-12 py-3 text-[10px] tracking-widest uppercase opacity-20">Path Subnet-A</div>
        <div class="text-zinc-800 font-bold">>>>></div>
        <div id="path-b" class="tech-border px-12 py-3 text-[10px] tracking-widest uppercase opacity-20">Path Subnet-B</div>
    </div>

    <div id="node-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-12"></div>

    <div class="tech-border p-4">
        <div class="text-[10px] uppercase tracking-widest text-emerald-500 font-bold border-b border-zinc-800 pb-2 mb-4">Core Intelligence Console</div>
        <div id="event-log" class="h-[300px] overflow-y-auto space-y-3 scrollbar-hide"></div>
    </div>

    <script>
        const ws = new WebSocket(`ws://${window.location.host}/ws`);
        const nodeGrid = document.getElementById('node-grid');
        const eventLog = document.getElementById('event-log');

        ws.onmessage = (event) => {
            const data = JSON.parse(event.data);
            if (data.type === 'stats') {
                updateNodes(data.scores);
                updateRouteVisuals(data.route);
            }
            if (data.type === 'resolution') updateLog(data.html);
        };

        function setOverride(target) { fetch(`/override/${target}`, { method: 'POST' }); }

        function updateRouteVisuals(routeStr) {
            document.getElementById('route-label').innerText = routeStr;
            const pathA = document.getElementById('path-a');
            const pathB = document.getElementById('path-b');
            const isManual = routeStr.includes("MANUAL");
            const activeClass = isManual ? "route-manual" : "route-active";

            pathA.className = routeStr.includes("SUBNET-A") ? `tech-border px-12 py-3 text-[10px] tracking-widest uppercase ${activeClass}` : "tech-border px-12 py-3 text-[10px] tracking-widest uppercase opacity-10";
            pathB.className = routeStr.includes("SUBNET-B") ? `tech-border px-12 py-3 text-[10px] tracking-widest uppercase ${activeClass}` : "tech-border px-12 py-3 text-[10px] tracking-widest uppercase opacity-10";
        }

        function updateNodes(scores) {
            nodeGrid.innerHTML = '';
            Object.entries(scores).forEach(([name, data]) => {
                const score = data.score;
                const lat = data.latency;
                
                // COLOR LOGIC: Green < 50ms | Orange 50-150ms | Red > 150ms
                let latColor = "text-emerald-500";
                let dotStatus = "bg-emerald-500 shadow-[0_0_8px_#10b981]";
                if (lat >= 50) { latColor = "text-amber-500"; dotStatus = "bg-amber-500 shadow-[0_0_8px_#f59e0b]"; }
                if (lat >= 150 || score < 30) { latColor = "text-red-500"; dotStatus = "bg-red-500 shadow-[0_0_8px_#ef4444]"; }

                nodeGrid.insertAdjacentHTML('beforeend', `
                    <div class="tech-border p-6">
                        <div class="flex justify-between items-start mb-6 text-[9px] uppercase tracking-widest text-zinc-600 font-bold">
                            <span>${name.includes('-a-') ? 'A-CORE' : 'B-CORE'}</span>
                            <span class="status-dot ${dotStatus}"></span>
                        </div>
                        <div class="text-4xl font-light text-white mb-2 tracking-tighter">${score}%</div>
                        <div class="text-[9px] uppercase mb-4 text-zinc-500 italic">RTT: <span class="${latColor} font-bold tracking-normal">${lat}ms</span></div>
                        <div class="bg-zinc-800 h-[1px] w-full"><div class="bg-white h-[1px]" style="width: ${score}%"></div></div>
                    </div>
                `);
            });
        }

        function updateLog(text) {
            const time = new Date().toLocaleTimeString('en-GB', { hour12: false });
            const entry = document.createElement('div');
            const isManual = text.includes("OPERATOR");
            entry.className = `p-3 border-l-2 ${isManual ? 'border-amber-500 bg-amber-500/5' : 'border-emerald-500 bg-emerald-500/5'} mb-2`;
            entry.innerHTML = `<div class="text-[9px] ${isManual ? 'text-amber-500' : 'text-emerald-500'} font-bold mb-1">[${time}] ${isManual ? 'MANUAL_OVERRIDE' : 'KERNEL_MSG'}</div><div class="text-[11px] text-zinc-300 leading-relaxed">${text}</div>`;
            eventLog.prepend(entry);
        }
    </script>
</body>
</html>
